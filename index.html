<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡Œå‹•èªè­˜AI</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç”»é¢ã®ã¡ã‚‰ã¤ãé˜²æ­¢ */
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-8 max-w-lg text-center">
        
        <h1 class="text-3xl font-bold mb-6">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡Œå‹•èªè­˜</h1>
        
        <!-- ã‚»ãƒ³ã‚µãƒ¼é–‹å§‹ãƒœã‚¿ãƒ³ -->
        <button id="startButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-2xl transition duration-300 shadow-lg">
            èªè­˜ã‚’é–‹å§‹
        </button>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="status" class="mt-6 text-xl text-gray-400 h-10">
            ã“ã“ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
        
        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="mt-8 bg-gray-800 rounded-lg p-12 shadow-2xl">
            <div class="text-3xl text-gray-400 mb-4">ç¾åœ¨ã®è¡Œå‹•</div>
            <div id="prediction" class="text-8xl font-bold text-blue-400 h-32">
                ---
            </div>
        </div>

    </div>

    <!-- TensorFlow.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>

    <script>
        // --- 1. å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const startButton = document.getElementById('startButton');
        const statusEl = document.getElementById('status');
        const predictionEl = document.getElementById('prediction');

        // ãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (Pythonã§ã®å­¦ç¿’æ™‚ã¨åˆã‚ã›ã‚‹)
        const WINDOW_SIZE = 100; // 100ã‚¹ãƒ†ãƒƒãƒ—
        const STEP_SIZE = 50;    // 50%ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—

        // 3ã‚¯ãƒ©ã‚¹åˆ†é¡ã®ãƒ©ãƒ™ãƒ«
        const LABELS_MAP = {
            0: { name: "Stay", emoji: "ğŸ§â€â™‚ï¸" },
            1: { name: "Walk", emoji: "ğŸš¶â€â™‚ï¸" },
            2: { name: "Run", emoji: "ğŸƒâ€â™‚ï¸" }
        };

        let model = null;            // ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¢ãƒ‡ãƒ«
        let dataBuffer = [];       // ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãŸã‚ã‚‹ãƒãƒƒãƒ•ã‚¡
        let isPredicting = false;  // äºˆæ¸¬ä¸­ã®ãƒ•ãƒ©ã‚°
        let lastAction = "";     // æœ€å¾Œã®äºˆæ¸¬çµæœ

        // --- 2. ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ ---
        async function loadModel() {
            statusEl.innerText = "AIãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
            try {
                // â˜…â˜…â˜… ã‚¹ãƒ†ãƒƒãƒ—2ã§å¤‰æ›ã—ãŸ model.json ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š â˜…â˜…â˜…
                const modelPath = './tfjs_model/model.json';
                model = await tf.loadLayersModel(modelPath);
                await model.warmup(); // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
                statusEl.innerText = "ã€Œèªè­˜ã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
                startButton.disabled = false;
                console.log("ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã¨ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—å®Œäº†");
            } catch (e) {
                statusEl.innerText = "ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                console.error(e);
            }
        }

        // --- 3. ã‚»ãƒ³ã‚µãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç† ---
        function startSensor() {
            statusEl.innerText = "ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            
            // iOS 13+ ã®ãŸã‚ã®ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            addSensorListener();
                        } else {
                            statusEl.innerText = "ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
                        }
                    })
                    .catch((e) => {
                        statusEl.innerText = "ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                        console.error(e);
                    });
            } else {
                // Android ã‚„ iOS 13æœªæº€
                addSensorListener();
            }
        }
        
        // ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
        function addSensorListener() {
            statusEl.innerText = "èªè­˜ä¸­... å‹•ã„ã¦ã¿ã¦ãã ã•ã„";
            startButton.style.display = 'none'; // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«
            
            try {
                // åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ (é‡åŠ›é™¤ã)
                // HASCãƒ‡ãƒ¼ã‚¿ãŒé‡åŠ›é™¤ãåŠ é€Ÿåº¦(accel)ã‹ã€é‡åŠ›è¾¼ã¿(accm)ã‹ä¸æ˜ãªãŸã‚ã€
                // 'acceleration' ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ç²¾åº¦ãŒæ‚ªã„å ´åˆã¯ 'accelerationIncludingGravity' ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚
                const motionSensor = new Sensor({ frequency: 20 }); // 20Hz (1ç§’ã«20å›)
                motionSensor.addEventListener('reading', () => {
                    handleMotion(motionSensor.x, motionSensor.y, motionSensor.z);
                });
                motionSensor.addEventListener('error', event => {
                   statusEl.innerText = 'ã‚»ãƒ³ã‚µãƒ¼ã‚¨ãƒ©ãƒ¼: ' + event.error.name;
                   console.error(event.error.name, event.error.message);
                });
                motionSensor.start();

            } catch (e) {
                statusEl.innerText = "ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                console.error(e);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦å¤ã„APIã‚’è©¦ã™
                window.addEventListener('devicemotion', (event) => {
                    if (event.acceleration) {
                         handleMotion(event.acceleration.x, event.acceleration.y, event.acceleration.z);
                    } else {
                        statusEl.innerText = "åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
                    }
                }, true);
            }
        }

        // --- 4. ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨äºˆæ¸¬ ---
        function handleMotion(x, y, z) {
            if (!model || isPredicting) {
                return; // ãƒ¢ãƒ‡ãƒ«ãŒæœªãƒ­ãƒ¼ãƒ‰ or äºˆæ¸¬ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ 
            dataBuffer.push([x, y, z]);

            // ãƒãƒƒãƒ•ã‚¡ãŒã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã«é”ã—ãŸã‚‰äºˆæ¸¬å®Ÿè¡Œ
            if (dataBuffer.length >= WINDOW_SIZE) {
                isPredicting = true; // äºˆæ¸¬é–‹å§‹ãƒ•ãƒ©ã‚°
                
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ‡ã‚Šå‡ºã™
                const windowData = dataBuffer.slice(0, WINDOW_SIZE);
                
                // ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã•ã›ã‚‹ (ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—)
                dataBuffer = dataBuffer.slice(STEP_SIZE);
                
                // äºˆæ¸¬ã‚’å®Ÿè¡Œ
                predict(windowData);
            }
        }

        // --- 5. äºˆæ¸¬ã®å®Ÿè¡Œ ---
        async function predict(windowData) {
            
            // tf.tidy() ã‚’ä½¿ã„ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ã
            tf.tidy(() => {
                // 1. ãƒ‡ãƒ¼ã‚¿ã‚’Tensorã«å¤‰æ›
                // (100, 3) ã®å½¢çŠ¶
                const inputTensor = tf.tensor2d(windowData); 
                
                // 2. ãƒãƒƒãƒæ¬¡å…ƒã‚’è¿½åŠ  (1, 100, 3) ã®å½¢çŠ¶
                const input = inputTensor.expandDims(0); 

                // 3. äºˆæ¸¬
                const prediction = model.predict(input);
                
                // 4. æœ€ã‚‚ç¢ºç‡ã®é«˜ã„ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
                const predictedIndex = prediction.argMax(1).dataSync()[0];
                
                // 5. çµæœã‚’è¡¨ç¤º
                const action = LABELS_MAP[predictedIndex];
                
                // å‰å›ã®çµæœã¨é•ã†å ´åˆã®ã¿ç”»é¢ã‚’æ›´æ–° (ã¡ã‚‰ã¤ãé˜²æ­¢)
                if (action.name !== lastAction) {
                    predictionEl.innerHTML = `${action.name} ${action.emoji}`;
                    lastAction = action.name;
                }
            });

            isPredicting = false; // äºˆæ¸¬å®Œäº†ãƒ•ãƒ©ã‚°
        }


        // --- åˆæœŸåŒ– ---
        startButton.addEventListener('click', startSensor);
        startButton.disabled = true;
        loadModel(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹

    </script>
</body>
</html>